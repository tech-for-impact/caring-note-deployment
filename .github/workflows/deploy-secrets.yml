name: Deploy Kubernetes Secrets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (staging or production)'
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-secrets:
    runs-on: ${{ inputs.environment }}  # staging ÎòêÎäî production ÎùºÎ≤® ÏÇ¨Ïö©
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify kubectl connection
        run: |
          # Self-hosted runnerÎäî VMÏóêÏÑú ÏßÅÏ†ë Ïã§ÌñâÎêòÎØÄÎ°ú kubectl ÏÑ§Ï†ï Î∂àÌïÑÏöî
          kubectl cluster-info
          kubectl get nodes

      - name: Create KCR Secret (Container Registry)
        run: |
          NAMESPACE="default"
          if [ "${{ inputs.environment }}" = "staging" ]; then
            NAMESPACE="caring-note-staging"
          fi

          kubectl create secret docker-registry kcr-secret \
            --docker-server=medi-bird.kr-central-2.kcr.dev \
            --docker-username=${{ secrets.KCR_ACCESS_KEY_ID }} \
            --docker-password=${{ secrets.KCR_SECRET_ACCESS_KEY }} \
            --namespace=${NAMESPACE} \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "‚úÖ KCR Secret created/updated in ${NAMESPACE}"

      - name: Create API Secrets
        run: |
          NAMESPACE="default"
          if [ "${{ inputs.environment }}" = "staging" ]; then
            NAMESPACE="caring-note-staging"
          fi

          kubectl create secret generic api-secret \
            --from-literal=SPRING_DATASOURCE_USERNAME='${{ secrets.DB_USERNAME }}' \
            --from-literal=SPRING_DATASOURCE_PASSWORD='${{ secrets.DB_PASSWORD }}' \
            --from-literal=OPEN_AI_API_KEY='${{ secrets.OPENAI_API_KEY }}' \
            --from-literal=CLOVA_API_KEY='${{ secrets.CLOVA_API_KEY }}' \
            --namespace=${NAMESPACE} \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "‚úÖ API Secret created/updated in ${NAMESPACE}"

      - name: Create PostgreSQL Secrets
        run: |
          NAMESPACE="default"
          if [ "${{ inputs.environment }}" = "staging" ]; then
            NAMESPACE="caring-note-staging"
          fi

          kubectl create secret generic postgresql \
            --from-literal=postgres-password='${{ secrets.POSTGRES_PASSWORD }}' \
            --from-literal=password='${{ secrets.POSTGRES_PASSWORD }}' \
            --namespace=${NAMESPACE} \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "‚úÖ PostgreSQL Secret created/updated in ${NAMESPACE}"

      - name: Create Keycloak Admin Secrets
        run: |
          NAMESPACE="default"
          if [ "${{ inputs.environment }}" = "staging" ]; then
            NAMESPACE="caring-note-staging"
          fi

          kubectl create secret generic keycloak \
            --from-literal=admin-password='${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}' \
            --namespace=${NAMESPACE} \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "‚úÖ Keycloak Admin Secret created/updated in ${NAMESPACE}"

      - name: Create Keycloak External DB Secrets
        run: |
          NAMESPACE="default"
          if [ "${{ inputs.environment }}" = "staging" ]; then
            NAMESPACE="caring-note-staging"
          fi

          kubectl create secret generic keycloak-externaldb \
            --from-literal=db-password='${{ secrets.KEYCLOAK_DB_PASSWORD }}' \
            --namespace=${NAMESPACE} \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "‚úÖ Keycloak External DB Secret created/updated in ${NAMESPACE}"

      - name: Verify Secrets
        run: |
          NAMESPACE="default"
          if [ "${{ inputs.environment }}" = "staging" ]; then
            NAMESPACE="caring-note-staging"
          fi

          echo "üìã Listing all secrets in ${NAMESPACE} namespace:"
          kubectl get secrets -n ${NAMESPACE}

          echo ""
          echo "‚úÖ All secrets deployed successfully to ${{ inputs.environment }} environment!"
